## Debugging with Cloudwatch. 

Returning to the code in `getMovieById.ts`, it starts by extracting the movie id from the event object parameter. Note the console log statement at the beginning of the function :
~~~ts
    console.log("Event: ", event);
~~~
We can use the output from this statement to explore the shape of the event object. First, request a movie (say, 1234) by submitting a request from a browser tab. Then,  in the management console, go to  CloudWatch --> Log Groups (left panel) --> /aws/lambda/SimpleAppStack-GetMovieByIdFn group --> Most recent Log steam. Expand the stream section generayed by the console log statement: 

![][eventshape1]

Scroll down the structure to find the query string parameters:

![][eventshape2]

Cloudwatch can also be useful when examining the structure of responses from the SDK. For example, add a console log statement to `getMovieById.ts` as follows:
~~~ts
   const commandOutput = await ddbDocClient.send(
     ... as before ...
    );
    console.log('GetCommand response: ', commandOutput)  // NEW
    if (!commandOutput.Item) {
      ... as before ...
~~~
Update the stack (cdk deploy) and resubmit a request for movie 1234. The Cloudwatch log stream for the new log statement looks as follows:

![][getcommand]

A common error for lambda functions is not having sufficient IAM permissions to access other AWS services, such as DynamoDB. In `simple-app-stack.ts` comment out the line:
~~~ts
    moviesTable.grantReadData(getMovieByIdFn)
~~~

Update the stack (cdk deploy) and try requesting movie 1234:

![][accessdenied1]

The error is easy to identify in this case because the exception thrown by the function is reported in the browser. However, many use cases for lambda functions does not involve triggering from a browser request (see later). To simulate this, temporarly comment out the try-catch in `getMovieById.ts`. Update the stack (cdk deploy) and try requesting movie 1234. This time we get a generic 'Internal Server Error'. To debug this, go to Cloudwatch and find the log stream for this invocation of the function:

![][accessdenied2]

You will frequently need to debug lambda functions this way. 

__Undo all the above code changes__, update the stack and check the get movie feature is working again.


[accessdenied1]: ./img/accessdenied1.png
[accessdenied2]: ./img/accessdenied2.png
[eventshape1]: ./img/eventshape1.png
[eventshape2]: ./img/eventshape2.png
[getcommand]: ./img/getcommand.png