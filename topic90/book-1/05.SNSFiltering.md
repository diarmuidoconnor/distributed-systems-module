## SNS Subscription Filtering (NEW).


Suppose a user can add metadata for an image, such as a caption, which the application stores in the related table item. The user submits the metadata as a message to the SNS topic. Consequently, there are two message types sent to the topic: S3 file uploads and Image Metadata. The SNS service must now filter messages to ensure it sends only the relevant messages to the topic subscribers.

![][filters]

### Metadata messages.

These messages will include two JSON documents: The Body and the Attributes. The message body should identify the image and contain the metadata value, and the message attribute should provide the metadata meaning. For example, a message to record a caption for an image would have a body and attribute as follows:
~~~json
 {  // Body
   name: 'image1.jpeg',
   value: 'My Christmas tree for 2025'
 }
{  // Attribute
    "metadata_type": {
        "DataType": "String",
        "StringValue": "Caption"
 }
}   
~~~

The only valid attributes are Caption, Date (as a string), and Photographer (name). A sample CLI command to add image metadata is as follows:
~~~json
$ aws sns publish --topic-arn "topic-arn" --message-attributes file://attributes.json --message file://message.json
~~~

### Code Updates

In `eda-app-stack.ts`: 

+ Add a new lambda function:
~~~ts
    const addMetadataFn = new lambdanode.NodejsFunction(
      this,
      "addMetadataFn",
 {
        runtime: lambda.Runtime.NODEJS_20_X,
        entry: `${__dirname}/../lambdas/addImageMetadata.ts`,
        timeout: cdk.Duration.seconds(15),
        memorySize: 128,
        environment: {
          TABLE_NAME: imagesTable.tableName,
        },
    }
 );
~~~
+ Subscribe this lambda to the topic, and enable filtering to ensure the function receives the correct messages:
~~~json
    newImageTopic.addSubscription(
      new subs.LambdaSubscription(addMetadataFn, {
        filterPolicy: {
          metadata_type: sns.SubscriptionFilter.stringFilter({
            allowlist: ["Caption", "Date", "Photographer"],
      }),
      },
    })
 );
~~~
+ Output the topic ARN:
~~~json
    new cdk.CfnOutput(this, "SNS Topic ARN", {
      value: newImageTopic.topicArn ,
     });
~~~

Create a new file `lambdas/addImageMetadata.ts`:
~~~ts
 /* eslint-disable import/extensions, import/no-absolute-path */
import { SNSHandler } from "aws-lambda";
import { DynamoDBClient } from "@aws-sdk/client-dynamodb";
import {
  DynamoDBDocumentClient,
  UpdateCommand,
} from "@aws-sdk/lib-dynamodb";
import { AttachmentTargetType } from "aws-cdk-lib/aws-secretsmanager";

const ddbDocClient = createDDbDocClient();

export const handler: SNSHandler = async (event) => {
  console.log("Event ", JSON.stringify(event));
  const message = JSON.parse(event.Records[0].Sns.Message);
  // console.log(message.value);
  // console.log(event.Records[0].Sns.MessageAttributes.metadata_type.Value);
  const attributeName =
    event.Records[0].Sns.MessageAttributes.metadata_type.Value.toString();
  const commandOutput = await ddbDocClient.send(
    new UpdateCommand({
      TableName: process.env.TABLE_NAME,
      Key: {
        name: message.name,
 },
      ExpressionAttributeValues: {
        ":value": message.value,
 },
      UpdateExpression: `SET ${attributeName} = :value`,
 })
 );
};

function createDDbDocClient() {
  const ddbClient = new DynamoDBClient({ region: process.env.REGION });
  const marshallOptions = {
    convertEmptyValues: true,
    removeUndefinedValues: true,
    convertClassInstanceToMap: true,
 };
  const unmarshallOptions = {
    wrapNumbers: false,
 };
  const translateConfig = { marshallOptions, unmarshallOptions };
  return DynamoDBDocumentClient.from(ddbClient, translateConfig);
}
~~~
The lambda adds a new attribute to an image's table item , e.g. Caption.

Deploy the updated stack.  Note the ARN of the SNS topic in the response.

Create two files, `message.json` and `attributes.json`, and add the following content:
~~~json
 {  //  message.json
 name: 'image1.jpeg',
 value: 'Joe Bloggs'
 }
 ------------------------
{  // attribute.json
 "metadata_type": {
 "DataType": "String",
 "StringValue": "Photographer"
 }
}   
~~~

From the command line:
~~~bash
$ aws sns publish --topic-arn "your-topic-arn"   --message-attributes file://attributes.json --message file://message.json
~~~

In the DynamoDB web console, confirm that a Photographer attribute has been added to the table item for image1.jpeg. If so, then the filter on the SNS Topic subscription for the add-metadata lambda is working. However, the aws command above also triggered the other topic subscribers in error, for example, check the CloudWatch logs for the process-image lambda function. To fix this, we need filters on the other subscribers. In this case, the same filter applies to the other existing subscribers: they should be triggered only when an image upload occurs. In `lib/eda-app-stack.ts`, add filters to the two other subscribers, as follows:
~~~ts
    newImageTopic.addSubscription(
      new subs.SqsSubscription(imageProcessQueue, {
        filterPolicyWithMessageBody: {
          Records: sns.FilterOrPolicy.policy({
            s3: sns.FilterOrPolicy.policy({
              object: sns.FilterOrPolicy.policy({
                key: sns.FilterOrPolicy.filter(
                  sns.SubscriptionFilter.stringFilter({
                    matchPrefixes: ["image"],
                 })

             ),
           }),
         }),
         }),
         },
        rawMessageDelivery: true,
      })
 );
~~~
and
~~~ts
    newImageTopic.addSubscription(
      new subs.SqsSubscription(mailerQ, {
        filterPolicyWithMessageBody: {
          Records: sns.FilterOrPolicy.policy({
            s3: sns.FilterOrPolicy.policy({
              object: sns.FilterOrPolicy.policy({
                key: sns.FilterOrPolicy.filter(
                  sns.SubscriptionFilter.stringFilter({
                    matchPrefixes: ["image"],
                  })
                ),
              }),
            }),
           }),
         },
        rawMessageDelivery: true,
      })
 );
~~~
The filter used here is classified as a __body filter__. It examines a property(s) of the message body for certain values - in this case that the Records.s3.object.key has a value the starts with 'image'. Mseeage attributes are ignored for this filter. 

To test them, change the JSON files to add a caption to image1.jpeg, as follows:
~~~json
 {  //  message.json
 name: 'image1.jpeg',
 value: 'This is a caption message'
 }
 ------------------------
{  // attribute.json
 "metadata_type": {
 "DataType": "String",
 "StringValue": "Caption"
 }
}   
~~~
Publish the message:
~~~bash
$ aws sns publish --topic-arn "your-topic-arn"   --message-attributes file://attributes.json --message file://message.json
~~~
Check the caption was added to the table item, and in CloudWatch logs, check that the process-image and mailer lambda functions __did not run__. 

Try some more tests:

1. Add an invalid matadate type, say Category. None of the lambda functions should execute, since none of the filters will pass the message to their subscribers.
1. Upload another image called image2.jpeg. This time, the process-image and mailer lambda functions should execute, but the add-metadara one should not.
1. Upload an image called picture.jpeg. None of the functions should be triggered.

Commit this work:
~~~bash
$ git add -A
$ git commit -m "Filter topic subscribers."
$ gitpush origin main
~~~

[filters]: ./img/filters.png
