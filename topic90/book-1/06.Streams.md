## DynamoDB Streams.

Currently, the application sends an email to the user when a message about the image upload is placed in the mail queue. An alternative design for this feature is to trigger the emailing when the image's database item is inserted, as illustrated below:

![][stream]


## Code changes.

In `lib/eda-stack.ts`:

+ Add an import:
~~~ts
import * as source from "aws-cdk-lib/aws-lambda-event-sources";
~~~
+ Configure the table to generate a stream:
~~~ts
    const imagesTable = new dynamodb.Table(this, "ImagesTable", {
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      partitionKey: { name: "name", type: dynamodb.AttributeType.STRING },
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      tableName: "Imagess",
      stream: dynamodb.StreamViewType.NEW_IMAGE.         //. UPDATE
 });
~~~
+ Remove the mail SQS queue code:
~~~ts

~~~
+ Remove the subscription of the mail queue to the topic:
~~~ts

~~~
+ Remove the mail queue event source that triggers the lambda function:
~~~ts

~~~
+ SetnamoDB stream as the event source for the lambda: the Dy
~~~ts
    mailerFn.addEventSource(
      new source.DynamoEventSource(imagesTable, {
        startingPosition: lambda.StartingPosition.LATEST
 })
 )
~~~

The lambda function must change because its event source has switched from the SQS queue to the DynamoDB stream. In `lambdas/mailer.ts`, 
+ Add some imports:
~~~ts
import { DynamoDBStreamHandler } from "aws-lambda";
import { unmarshall } from "@aws-sdk/util-dynamodb";
~~~
+ Replace the handler function with the following:
~~~ts
export const handler: DynamoDBStreamHandler = async (event: any) => {
  console.log("Event ", JSON.stringify(event));
  for (const record of event.Records) {
    if (record.eventName == "INSERT") {
      const dbItem = unmarshall(record.dynamodb.NewImage);
      try {
        const { name, email, message }: ContactDetails = {
          name: "The Photo Album",
          email: SES_EMAIL_FROM,
          message: `We received your Image ${dbItem.name}`,
 };
        const params = sendEmailParams({ name, email, message });
        await client.send(new SendEmailCommand(params));
 } catch (error: unknown) {
        console.log("ERROR is: ", error);
        // return;
 }
~~~

Update the stack:
~~~bash
$ cdk deploy
~~~
And upload an image to the bucket. You should still receive an email confirmation. In CloudWatch logs, check the log stream for the mailer function.

Commit this work:
~~~bash
$ git add -A
$ git commit -m "Change mailer trigger to the DB stream.."
$ git push origin main
~~~

[stream]: ./img/stream.png
